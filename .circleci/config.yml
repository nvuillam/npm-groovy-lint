---
  version: 3
  jobs:
    node-latest: &test
      docker:
        - image: webpackcontrib/circleci-node-jdk8
      working_directory: ~/cli
      steps:
        - checkout
        - restore_cache: &restore_cache
            keys:
              - v1-npm-{{checksum ".circleci/config.yml"}}-{{checksum "package-lock.json"}}
              - v1-npm-{{checksum ".circleci/config.yml"}}
        - run:
            name: Install dependencies
            command: npm install && npm install jdeploy -g
        - run:
            name: Testing
            command: npm run test:coverage
        - run:
            name: Submitting code coverage to codecov
            command: |
              ./node_modules/.bin/nyc report --reporter text-lcov > coverage.lcov
              curl -s https://codecov.io/bash | bash
#    node-8:
#      <<: *test
#      docker:
#        - image: node:8
    node-10:
      <<: *test
      docker:
        - image: node:10
    cache:
      <<: *test
      steps:
        - checkout
        - run:
            name: Install dependencies
            command: npm install
        - save_cache:
            key: v1-npm-{{checksum ".circleci/config.yml"}}-{{checksum "package-lock.json"}}
            paths:
              - ~/cli/node_modules
              - /usr/local/share/.cache/npm
              - /usr/local/share/.config/npm
  
  workflows:
    version: 2
    "npm-groovy-lint-build-test":
      jobs:
        - node-latest
#        - node-8
#        - node-10
        - cache:
            filters:
              tags:
                only: /^v.*/
              branches:
                ignore: /.*/